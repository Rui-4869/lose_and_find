{% extends "base.html" %}

{% block content %}
{% if current_user.is_authenticated %}
<div class="row g-4 mb-3">
	<div class="col-lg-6">
		<div class="card shadow-sm">
			<div class="card-body d-flex flex-column gap-3">
				<div>
					<h5 class="card-title">å‘å¸ƒå¤±ç‰©ä¿¡æ¯</h5>
					<p class="card-text text-muted">è®°å½•é—å¤±ç‰©å“çš„ç±»åˆ«ã€åœ°ç‚¹ä¸æè¿°ï¼Œå¯éšæ—¶å¯åŠ¨æ™ºèƒ½ä½“è¿›è¡ŒåŒ¹é…ã€‚</p>
				</div>
				<a class="btn btn-primary rounded-pill align-self-start px-3" href="{{ url_for('create_lost_item') }}"><i class="bi bi-plus-lg me-1"></i> å‰å¾€å¡«å†™</a>
			</div>
		</div>
	</div>
	<div class="col-lg-6">
		<div class="card shadow-sm">
			<div class="card-body d-flex flex-column gap-3">
				<div>
					<h5 class="card-title">å‘å¸ƒæ‹›é¢†ä¿¡æ¯</h5>
					<p class="card-text text-muted">è®°å½•æ‹¾åˆ°ç‰©å“çš„å…³é”®ä¿¡æ¯ï¼Œä¸»åŠ¨è§¦å‘æ™ºèƒ½åŒ¹é…å¸®åŠ©å¤±ä¸»ã€‚</p>
				</div>
				<a class="btn btn-success rounded-pill align-self-start px-3" href="{{ url_for('create_found_item') }}"><i class="bi bi-plus-lg me-1"></i> å‰å¾€å¡«å†™</a>
			</div>
		</div>
	</div>
</div>

<!-- æˆ‘çš„è®°å½•æ¨¡å— -->
<div class="row g-4 mb-4">
	<div class="col-lg-6">
		<div class="card shadow-sm h-100">
			<div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
				<h5 class="mb-0"><i class="bi bi-person-check"></i> æˆ‘çš„å¤±ç‰©è®°å½•</h5>
				<span class="badge bg-light text-primary">{{ my_lost_items|length }}</span>
			</div>
			<div class="list-group list-group-flush">
				{% if my_lost_items %}
					{% for item in my_lost_items %}
						<div class="list-group-item">
							<div class="d-flex justify-content-between align-items-start">
								<div class="me-3 flex-grow-1">
									<a class="stretched-link text-body text-decoration-none" href="{{ url_for('view_lost_item', lost_id=item.id) }}">
										<div class="d-flex align-items-start gap-3">
											{% if item.image_path %}
											<img src="{{ url_for('static', filename=item.image_path) }}" alt="{{ item.category }} ç…§ç‰‡" class="rounded shadow-sm" style="width:64px;height:64px;object-fit:cover;">
											{% endif %}
											<div class="flex-grow-1">
												<div class="d-flex w-100 justify-content-between mb-1">
													<h6 class="mb-0">{{ item.category }}</h6>
													<small class="text-muted">{{ item.occurred_at.strftime('%Y-%m-%d') }}</small>
												</div>
												<p class="mb-1 text-muted small">{{ item.description[:30] }}{% if item.description|length > 30 %}...{% endif %}</p>
												<p class="mb-0 text-muted small">ğŸ“ {{ item.location }}</p>
											</div>
										</div>
									</a>
								</div>
								<form method="post" action="{{ url_for('delete_lost_item', lost_id=item.id) }}" onsubmit="return confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ');" style="display: inline;">
									<button class="btn btn-sm btn-outline-danger" type="submit">åˆ é™¤</button>
								</form>
							</div>
						</div>
					{% endfor %}
				{% else %}
					<div class="list-group-item text-center text-muted py-4">
						<p class="mb-0">è¿˜æ²¡æœ‰å¤±ç‰©è®°å½•</p>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
	<div class="col-lg-6">
		<div class="card shadow-sm h-100">
			<div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
				<h5 class="mb-0"><i class="bi bi-hand-thumbs-up"></i> æˆ‘çš„æ‹›é¢†è®°å½•</h5>
				<span class="badge bg-light text-success">{{ my_found_items|length }}</span>
			</div>
			<div class="list-group list-group-flush">
				{% if my_found_items %}
					{% for item in my_found_items %}
						<div class="list-group-item">
							<div class="d-flex justify-content-between align-items-start">
								<div class="me-3 flex-grow-1">
									<a class="stretched-link text-body text-decoration-none" href="{{ url_for('view_found_item', found_id=item.id) }}">
										<div class="d-flex align-items-start gap-3">
											{% if item.image_path %}
											<img src="{{ url_for('static', filename=item.image_path) }}" alt="{{ item.category }} ç…§ç‰‡" class="rounded shadow-sm" style="width:64px;height:64px;object-fit:cover;">
											{% endif %}
											<div class="flex-grow-1">
												<div class="d-flex w-100 justify-content-between mb-1">
													<h6 class="mb-0">{{ item.category }}</h6>
													<small class="text-muted">{{ item.occurred_at.strftime('%Y-%m-%d') }}</small>
												</div>
												<p class="mb-1 text-muted small">{{ item.description[:30] }}{% if item.description|length > 30 %}...{% endif %}</p>
												<p class="mb-0 text-muted small">ğŸ“ {{ item.location }}</p>
											</div>
										</div>
									</a>
								</div>
								<form method="post" action="{{ url_for('delete_found_item', found_id=item.id) }}" onsubmit="return confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ');" style="display: inline;">
									<button class="btn btn-sm btn-outline-danger" type="submit">åˆ é™¤</button>
								</form>
							</div>
						</div>
					{% endfor %}
				{% else %}
					<div class="list-group-item text-center text-muted py-4">
						<p class="mb-0">è¿˜æ²¡æœ‰æ‹›é¢†è®°å½•</p>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>
{% else %}
<section class="hero text-center bg-white mb-4 section-gap">
    <div class="container py-5">
        <h1 class="display-5 fw-bold">æ ¡å›­å¤±ç‰©æ‹›é¢†æ™ºèƒ½æ¨è</h1>
        <p class="lead text-muted">å¿«é€Ÿå‘å¸ƒå¤±ç‰©ä¸æ‹›é¢†ï¼ŒåŸºäºæ™ºèƒ½åŒ¹é…å¸®åŠ©å°½å¿«æ‰¾å›ä¸¢å¤±ç‰©å“ï¼Œç¤¾åŒºåä½œæ›´é«˜æ•ˆã€‚</p>
        <div class="d-flex justify-content-center gap-3 my-3">
            <a class="btn btn-primary btn-lg rounded-pill fw-semibold px-4" href="{{ url_for('login') }}">ç™»å½•</a>
            <a class="btn btn-outline-primary btn-lg rounded-pill fw-semibold px-4" href="{{ url_for('register') }}">æ³¨å†Œ</a>
        </div>
        <form class="d-flex justify-content-center mt-4" method="get" action="{{ url_for('index') }}">
            <div class="input-group w-50 shadow-sm">
                <input type="search" name="q" class="form-control" placeholder="æœç´¢å¤±ç‰©æˆ–åœ°ç‚¹ï¼Œä¾‹å¦‚ï¼šé’±åŒ… / å›¾ä¹¦é¦†" aria-label="æœç´¢">
                <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
            </div>
        </form>
    </div>
</section>

<section class="container mb-4 section-gap">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">æœ€æ–°å¤±ç‰©é¢„è§ˆ</h4>
        <small class="small-muted">ç™»å½•æŸ¥çœ‹å®Œæ•´è¯¦æƒ…ä¸è”ç³»æ–¹å¼</small>
    </div>
    <div class="row g-3 card-preview">
        {% if all_lost_items %}
            {% for item in all_lost_items[:3] %}
                <div class="col-sm-6 col-md-4">
                    <div class="card h-100 shadow-sm">
                        {% if item.image_path %}
                        <img src="{{ url_for('static', filename=item.image_path) }}" class="card-img-top" alt="{{ item.category }}">
                        {% endif %}
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title mb-1">{{ item.category }}</h6>
                            <p class="card-text text-muted small mb-3">{{ item.description[:60] }}{% if item.description|length > 60 %}...{% endif %}</p>
                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                <small class="text-muted">ğŸ“ {{ item.location }}</small>
                                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('login') }}">ç™»å½•æŸ¥çœ‹</a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center text-muted py-4">å½“å‰æ²¡æœ‰å¤±ç‰©è®°å½•</div>
        {% endif %}
    </div>
</section>

<section class="container mb-4 section-gap">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">æœ€æ–°æ‹›é¢†é¢„è§ˆ</h4>
        <small class="small-muted">ç™»å½•æŸ¥çœ‹å®Œæ•´è¯¦æƒ…ä¸è”ç³»æ–¹å¼</small>
    </div>
    <div class="row g-3 card-preview">
        {% if all_found_items %}
            {% for item in all_found_items[:3] %}
                <div class="col-sm-6 col-md-4">
                    <div class="card h-100 shadow-sm">
                        {% if item.image_path %}
                        <img src="{{ url_for('static', filename=item.image_path) }}" class="card-img-top" alt="{{ item.category }}">
                        {% endif %}
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title mb-1">{{ item.category }}</h6>
                            <p class="card-text text-muted small mb-3">{{ item.description[:60] }}{% if item.description|length > 60 %}...{% endif %}</p>
                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                <small class="text-muted">ğŸ“ {{ item.location }}</small>
                                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('login') }}">ç™»å½•æŸ¥çœ‹</a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center text-muted py-4">å½“å‰æ²¡æœ‰æ‹›é¢†è®°å½•</div>
        {% endif %}
    </div>
</section>
{% endif %}

{% endblock %}

<!-- æœ€æ–°è®°å½•æ¨¡å— -->
<div class="row g-4">
	<div class="col-lg-6">
		<div class="card shadow-sm h-100">
			<div class="card-header bg-white d-flex justify-content-between align-items-center">
				<h5 class="mb-0"><i class="bi bi-clock-history"></i> æœ€æ–°å¤±ç‰©è®°å½•</h5>
				<span class="text-muted small">å…± {{ all_lost_items|length }} æ¡</span>
			</div>
			<div class="list-group list-group-flush">
				{% if all_lost_items %}
					{% for item in all_lost_items %}
						<div class="list-group-item">
							<a class="stretched-link text-body text-decoration-none" href="{{ url_for('view_lost_item', lost_id=item.id) }}">
								<div class="d-flex align-items-start gap-3">
									{% if item.image_path %}
									<img src="{{ url_for('static', filename=item.image_path) }}" alt="{{ item.category }} ç…§ç‰‡" class="rounded shadow-sm" style="width:64px;height:64px;object-fit:cover;">
									{% endif %}
									<div class="flex-grow-1">
										<div class="d-flex w-100 justify-content-between mb-1">
											<h6 class="mb-0">{{ item.category }}</h6>
											<small class="text-muted">{{ item.occurred_at.strftime('%Y-%m-%d %H:%M') }}</small>
										</div>
										<p class="mb-1 text-muted small">{{ item.description[:35] }}{% if item.description|length > 35 %}...{% endif %}</p>
										<p class="mb-0 text-muted small">ğŸ“ {{ item.location }} | æŠ¥å‘Šè€…: {{ item.reporter_name or item.owner.username }}</p>
									</div>
								</div>
							</a>
						</div>
					{% endfor %}
				{% else %}
					<div class="list-group-item text-center text-muted py-4">
						<p class="mb-0">æš‚æ—¶æ²¡æœ‰å¤±ç‰©è®°å½•</p>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
	<div class="col-lg-6">
		<div class="card shadow-sm h-100">
			<div class="card-header bg-white d-flex justify-content-between align-items-center">
				<h5 class="mb-0"><i class="bi bi-clock-history"></i> æœ€æ–°æ‹›é¢†è®°å½•</h5>
				<span class="text-muted small">å…± {{ all_found_items|length }} æ¡</span>
			</div>
			<div class="list-group list-group-flush">
				{% if all_found_items %}
					{% for item in all_found_items %}
						<div class="list-group-item">
							<a class="stretched-link text-body text-decoration-none" href="{{ url_for('view_found_item', found_id=item.id) }}">
								<div class="d-flex align-items-start gap-3">
									{% if item.image_path %}
									<img src="{{ url_for('static', filename=item.image_path) }}" alt="{{ item.category }} ç…§ç‰‡" class="rounded shadow-sm" style="width:64px;height:64px;object-fit:cover;">
									{% endif %}
									<div class="flex-grow-1">
										<div class="d-flex w-100 justify-content-between mb-1">
											<h6 class="mb-0">{{ item.category }}</h6>
											<small class="text-muted">{{ item.occurred_at.strftime('%Y-%m-%d %H:%M') }}</small>
										</div>
										<p class="mb-1 text-muted small">{{ item.description[:35] }}{% if item.description|length > 35 %}...{% endif %}</p>
										<p class="mb-0 text-muted small">ğŸ“ {{ item.location }} | æŠ¥å‘Šè€…: {{ item.reporter_name or item.owner.username }}</p>
									</div>
								</div>
							</a>
						</div>
					{% endfor %}
				{% else %}
					<div class="list-group-item text-center text-muted py-4">
						<p class="mb-0">æš‚æ—¶æ²¡æœ‰æ‹›é¢†è®°å½•</p>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>


<!-- æ™ºèƒ½ä½“åŒ¹é…æ¨èæ¨¡å— -->
{% if current_user.is_authenticated %}
<div class="card shadow-sm mt-4">
	<div class="card-header bg-white">
		<h5 class="mb-0"><i class="bi bi-robot"></i> æˆ‘çš„æ™ºèƒ½ä½“åŒ¹é…æ¨è</h5>
	</div>
	<div class="table-responsive">
		<table class="table table-striped mb-0">
			<thead class="table-light">
				<tr>
					<th scope="col">ç­‰çº§</th>
					<th scope="col">å¤±ç‰©</th>
					<th scope="col">æ‹›é¢†</th>
					<th scope="col">åˆ†æ•°</th>
					<th scope="col">ç†ç”±</th>
					<th scope="col" class="text-center">æ“ä½œ</th>
				</tr>
			</thead>
			<tbody>
				{% if matches %}
					{% for match in matches %}
						<tr>
							<td>
								<span class="badge 
									{% if match.level == 'é«˜åŒ¹é…' %}bg-success
									{% elif match.level == 'ä¸­åŒ¹é…' %}bg-info
									{% else %}bg-warning{% endif %}">
									{{ match.level }}
								</span>
							</td>
							<td class="align-middle">
								<div class="d-flex align-items-start gap-3">
									{% if match.lost_item.image_path %}
									<img src="{{ url_for('static', filename=match.lost_item.image_path) }}" alt="{{ match.lost_item.category }} ç…§ç‰‡" class="rounded shadow-sm" style="width:56px;height:56px;object-fit:cover;">
									{% endif %}
									<div>
										<div class="fw-semibold mb-1">{{ match.lost_item.category }}</div>
										<div class="text-muted small">{{ match.lost_item.description[:30] }}{% if match.lost_item.description|length > 30 %}...{% endif %}</div>
										<div class="mt-2">
											<a class="btn btn-sm btn-outline-secondary rounded-pill" href="{{ url_for('view_lost_item', lost_id=match.lost_item.id) }}">æŸ¥çœ‹å¤±ç‰©</a>
										</div>
									</div>
								</div>
							</td>
							<td class="align-middle">
								<div class="d-flex align-items-start gap-3">
									{% if match.found_item.image_path %}
									<img src="{{ url_for('static', filename=match.found_item.image_path) }}" alt="{{ match.found_item.category }} ç…§ç‰‡" class="rounded shadow-sm" style="width:56px;height:56px;object-fit:cover;">
									{% endif %}
									<div>
										<div class="fw-semibold mb-1">{{ match.found_item.category }}</div>
										<div class="text-muted small">{{ match.found_item.description[:30] }}{% if match.found_item.description|length > 30 %}...{% endif %}</div>
										<div class="mt-2">
											<a class="btn btn-sm btn-outline-secondary rounded-pill" href="{{ url_for('view_found_item', found_id=match.found_item.id) }}">æŸ¥çœ‹æ‹›é¢†</a>
										</div>
									</div>
								</div>
							</td>
							<td><strong>{{ match.score }}</strong></td>
							<td>{{ match.reason or "-" }}</td>
							<td class="text-center">
								{% if match.is_completed %}
									<span class="badge bg-secondary">å·²å®Œæˆ</span>
								{% else %}
									<form method="post" action="{{ url_for('complete_match', match_id=match.id) }}" onsubmit="return confirm('ç¡®è®¤è¯¥åŒ¹é…å·²å®Œæˆï¼Ÿ');">
										<button class="btn btn-sm btn-outline-primary" type="submit">ç¡®è®¤å®Œæˆ</button>
									</form>
								{% endif %}
							</td>
						</tr>
					{% endfor %}
				{% else %}
					<tr>
						<td colspan="6" class="text-center py-4 text-muted">æš‚æ— åŒ¹é…ç»“æœï¼Œæäº¤è®°å½•å¹¶å¯åŠ¨åŒ¹é…è·å¾—æ¨èã€‚</td>
					</tr>
				{% endif %}
			</tbody>
		</table>
	</div>
</div>
{% endif %}
