{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-lg-8 mx-auto">

    <!-- ================= ç‰©å“è¯¦æƒ… ================= -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
          {% if item_type == "lost" %}å¤±ç‰©è¯¦æƒ…{% else %}æ‹›é¢†è¯¦æƒ…{% endif %}
        </h4>
        <a href="{{ url_for('index') }}" class="btn btn-sm btn-secondary rounded-pill">è¿”å›åˆ—è¡¨</a>
      </div>

      <div class="card-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="text-muted">ç‰©å“ç±»åˆ«</h6>
            <p class="lead">{{ item.category }}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">æŠ¥å‘Šäºº</h6>
            <p class="lead">{{ item.reporter_name or item.owner.username }}</p>
          </div>
        </div>

        {% if item.image_path %}
        <div class="mb-4">
          <h6 class="text-muted">ç‰©å“ç…§ç‰‡</h6>
          <a href="{{ url_for('static', filename=item.image_path) }}" target="_blank">
            <img src="{{ url_for('static', filename=item.image_path) }}"
                 class="img-fluid rounded shadow-sm">
          </a>
        </div>
        {% endif %}

        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="text-muted">å‘ç”Ÿåœ°ç‚¹</h6>
            <p>{{ item.location }}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">å‘ç”Ÿæ—¶é—´</h6>
            <p>{{ item.occurred_at.strftime('%Y-%m-%d %H:%M') }}</p>
          </div>
        </div>

        <div class="mb-4">
          <h6 class="text-muted">ç‰©å“æè¿°</h6>
          <div class="alert alert-light border">{{ item.description }}</div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <h6 class="text-muted">è”ç³»æ–¹å¼</h6>
            <p>{{ item.contact_info or "æœªæä¾›" }}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">æäº¤æ—¶é—´</h6>
            <p>{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= åŒ¹é…ç»“æœï¼ˆä¼˜åŒ– + æœªè¯»æç¤ºï¼‰ ================= -->
    {% if is_owner %}
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0">æ™ºèƒ½åŒ¹é…ç»“æœ</h5>
      </div>

      <div class="card-body">
        {% if item_matches %}
        <div class="d-flex flex-column gap-3">
          {% for match in item_matches %}
          <div class="border rounded p-3 {% if match.is_completed %}bg-light{% endif %}">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <span class="badge bg-info">{{ match.level }}</span>
                <span class="ms-2 text-muted">åˆ†æ•°ï¼š</span>
                <span class="fw-bold">{{ match.score }}</span>
              </div>
              {% if match.is_completed %}
                <span class="badge bg-secondary">å·²å®Œæˆ</span>
              {% endif %}
            </div>

            {% if item_type == "lost" %}
              <strong>{{ match.found_item.category }}</strong>
              <p class="text-muted mb-1">{{ match.found_item.description[:60] }}</p>
              <small class="text-muted">ğŸ“ {{ match.found_item.location }}</small><br>
              <small class="text-muted">ğŸ“ {{ match.found_item.contact_info or "æœªæä¾›" }}</small><br>
              <a href="{{ url_for('view_found_item', found_id=match.found_item.id) }}"
                 class="btn btn-sm btn-outline-secondary rounded-pill mt-2">
                æŸ¥çœ‹æ‹›é¢†è¯¦æƒ…
              </a>
            {% else %}
              <strong>{{ match.lost_item.category }}</strong>
              <p class="text-muted mb-1">{{ match.lost_item.description[:60] }}</p>
              <small class="text-muted">ğŸ“ {{ match.lost_item.location }}</small><br>
              <small class="text-muted">ğŸ“ {{ match.lost_item.contact_info or "æœªæä¾›" }}</small><br>
              <a href="{{ url_for('view_lost_item', lost_id=match.lost_item.id) }}"
                 class="btn btn-sm btn-outline-secondary rounded-pill mt-2">
                æŸ¥çœ‹å¤±ç‰©è¯¦æƒ…
              </a>
            {% endif %}

            {% if match.reason %}
            <div class="alert alert-light border mt-2 mb-2">
              <strong>åŒ¹é…ç†ç”±ï¼š</strong>{{ match.reason }}
            </div>
            {% endif %}

            {% if not match.is_completed %}
            <div class="d-flex justify-content-end gap-2">
              <form method="post"
                    action="{{ url_for('complete_match', match_id=match.id) }}"
                    onsubmit="return confirm('ç¡®è®¤è¯¥åŒ¹é…å·²å®Œæˆï¼Ÿ');">
                <button class="btn btn-sm btn-outline-primary rounded-pill">
                  ç¡®è®¤å®Œæˆ
                </button>
              </form>

              <!-- ğŸ”´ æŸ¥çœ‹èŠå¤©ï¼ˆä¿®å¤ + æœªè¯»æç¤ºï¼‰ -->
              <button type="button"
                      class="btn btn-sm btn-outline-secondary rounded-pill position-relative"
                      data-bs-toggle="modal"
                      data-bs-target="#chatModal"
                      data-match-id="{{ match.id }}">
                æŸ¥çœ‹èŠå¤©
                <span class="badge bg-danger position-absolute top-0 start-100 translate-middle d-none"
                      id="unread-badge-{{ match.id }}">â—</span>
              </button>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% else %}
          <p class="text-center text-muted mb-0">æš‚æ— åŒ¹é…ç»“æœ</p>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- ================= èŠå¤© Modalï¼ˆåŸåŠŸèƒ½ä¿ç•™ï¼‰ ================= -->
<div class="modal fade" id="chatModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">åŒ¹é…èŠå¤©</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="chatAlert"></div>
        <div id="chatMessages" class="d-flex flex-column gap-3 p-3"
             style="max-height:380px; overflow:auto; background:#f8f9fa; border-radius:8px;"></div>
        <form id="chatForm" class="mt-3 d-flex gap-2">
          <input id="chatInput" class="form-control" placeholder="å‘é€æ¶ˆæ¯...">
          <button class="btn btn-primary rounded-pill">å‘é€</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const chatModalEl = document.getElementById('chatModal');
  let currentMatchId = null;
  let polling = null;

  // è®°å½•æ¯ä¸ª match æœ€åå·²è¯»æ—¶é—´
  const lastReadMap = {};

  const currentUserId = {{ current_user.id if current_user.is_authenticated else 'null' }};

  /* ================= æ‹‰å–å¹¶æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆæ‰“å¼€èŠå¤©æ—¶ï¼‰ ================= */
  async function fetchMessages(){
    if(!currentMatchId) return;

    const res = await fetch(`/matches/${currentMatchId}/messages`, {
      credentials: 'same-origin'
    });
    if(!res.ok) return;

    const data = await res.json();
    const box = document.getElementById('chatMessages');
    box.innerHTML = '';

    data.messages.forEach(m => {
      const isMe = m.sender_id === currentUserId;
      const wrapper = document.createElement('div');
      wrapper.className = isMe ? 'text-end' : 'text-start';

      wrapper.innerHTML = `
        <div class="d-inline-block p-2 rounded ${isMe ? 'bg-primary text-white' : 'bg-white'}">
          <div>${m.content}</div>
          <small class="text-muted">
            ${new Date(m.created_at).toLocaleString()}
          </small>
        </div>
      `;
      box.appendChild(wrapper);
    });

    box.scrollTop = box.scrollHeight;

    // â­ æ‰“å¼€èŠå¤©å³è§†ä¸ºâ€œå·²è¯»â€
    if(data.messages.length){
      lastReadMap[currentMatchId] =
        new Date(data.messages[data.messages.length - 1].created_at).getTime();

      const badge = document.getElementById(`unread-badge-${currentMatchId}`);
      if(badge) badge.classList.add('d-none');
    }
  }

  /* ================= æ£€æŸ¥æ˜¯å¦æœ‰â€œå¯¹æ–¹çš„æ–°æ¶ˆæ¯â€ ================= */
  async function checkUnread(matchId){
    // æ­£åœ¨çœ‹çš„èŠå¤©ï¼Œä¸æ˜¾ç¤ºçº¢ç‚¹
    if(currentMatchId === matchId) return;

    const res = await fetch(`/matches/${matchId}/messages`, {
      credentials: 'same-origin'
    });
    if(!res.ok) return;

    const data = await res.json();
    if(!data.messages.length) return;

    const lastMsg = data.messages[data.messages.length - 1];

    // â— å…³é”®ä¿®å¤ï¼šåªå…³å¿ƒâ€œå¯¹æ–¹å‘çš„æ¶ˆæ¯â€
    if(lastMsg.sender_id === currentUserId) return;

    const lastMsgTime = new Date(lastMsg.created_at).getTime();
    const lastReadTime = lastReadMap[matchId] || 0;

    if(lastMsgTime > lastReadTime){
      const badge = document.getElementById(`unread-badge-${matchId}`);
      if(badge) badge.classList.remove('d-none');
    }
  }

  /* ================= æ‰“å¼€ / å…³é—­ Modal ================= */
  chatModalEl.addEventListener('show.bs.modal', e => {
    currentMatchId = e.relatedTarget.getAttribute('data-match-id');
    fetchMessages();
    polling = setInterval(fetchMessages, 2500);
  });

  chatModalEl.addEventListener('hide.bs.modal', () => {
    if(polling) clearInterval(polling);
    polling = null;
    currentMatchId = null;
  });

  /* ================= å‘é€æ¶ˆæ¯ ================= */
  document.getElementById('chatForm').addEventListener('submit', async e => {
    e.preventDefault();
    if(!currentMatchId) return;

    const input = document.getElementById('chatInput');
    const content = input.value.trim();
    if(!content) return;

    const form = new FormData();
    form.append('content', content);

    await fetch(`/matches/${currentMatchId}/messages`, {
      method: 'POST',
      body: form,
      credentials: 'same-origin'
    });

    input.value = '';
    fetchMessages();
  });

  /* ================= å®šæ—¶è½®è¯¢æ‰€æœ‰åŒ¹é…çš„æœªè¯»çŠ¶æ€ ================= */
  document.querySelectorAll('[data-match-id]').forEach(btn => {
    const matchId = btn.getAttribute('data-match-id');
    setInterval(() => checkUnread(matchId), 100);
  });

})();
</script>

{% endblock %}
